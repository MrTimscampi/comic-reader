<!doctype html>
<html lang="en">
<title>&lt;comic-reader&gt; demo</title>
<style>
  comic-reader {
    height: 400px;
  }
</style>

<main>
  <input id="fileInput" type="file">

  <div id="time"></div>
</main>

<script type="module">
  async function zipjs() {
    const { default: zip } = await import('../lib/zipjs/zip.js');
    let pth = new URL('../lib/zipjs/', import.meta.url).toString();
    zip.workerScriptsPath = pth;

    function getEntries(blob) {
      let blobReader = new zip.BlobReader(blob);
      return new Promise((resolve, reject) => {
        zip.createReader(blobReader, zipReader => {
          zipReader.getEntries(resolve);
        }, reject);
      });
    }

    function getBlob(entry, onprogress = Function.prototype) {
      let writer = new zip.BlobWriter();

      function calculateProgress(bytes) {
        let perc = bytes / entry.compressedSize;
        onprogress(perc);
      }

      return new Promise(resolve => {
        entry.getData(writer, blob => {
          let url = URL.createObjectURL(blob);
          resolve(url);
        }, calculateProgress);
      });
    }

    async function extract(file) {
      let start = Date.now();
      let entries = await getEntries(file);
      console.log('Entries', Date.now() - start);

      let p = [];
      for(let entry of entries) {
        if(!entry.directory)
          p.push(getBlob(entry));
      }

      await Promise.all(p);
      console.log('Extract', Date.now() - start);
    }

    fileInput.addEventListener('change', ev => {
      let file = ev.target.files[0];
      extract(file);
    });
  }

  async function libarchive() {
    const { Archive } = await import('../node_modules/libarchive.js/main.js');

    let url = new URL('../node_modules/libarchive.js/dist/worker-bundle.js', import.meta.url).toString();
    
    Archive.init({
      workerUrl: url
    });

    async function extract(file) {
      let start = new Date();
      const archive = await Archive.open(file);
      console.log('Archive', Date.now() - start, archive);
      let files = await archive.getFilesArray();
      console.log('Files', Date.now() - start, files.length);
      let obj = await archive.extractFiles(Function.prototype);
      console.log('extract', Date.now() - start);
    }

    fileInput.addEventListener('change', ev => {
      let file = ev.target.files[0];
      extract(file);
    });
  }

  libarchive();
  //zipjs();

</script>